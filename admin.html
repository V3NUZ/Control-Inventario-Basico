<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .btn {
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .tab-button.active {
            background: #7c3aed;
            color: white;
        }
        
        .assignment-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .employee-card {
            transition: all 0.2s ease;
        }
        
        .employee-card:hover {
            background: #f9fafb;
        }
    </style>
</head>
<body class="gradient-bg">
    <!-- Header -->
    <header class="glass-effect rounded-2xl shadow-xl p-6 mb-6 fade-in">
        <div class="flex justify-between items-center flex-wrap gap-4">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center">
                    <i class="fas fa-users-cog text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Panel de Administración</h1>
                    <p class="text-gray-600">Gestión de Usuarios y Tiendas</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <div class="text-sm font-medium text-gray-800" id="currentUser">Administrador</div>
                    <div class="text-xs text-gray-600">Administrador</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.location.href='index.html'" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 btn">
                        <i class="fas fa-arrow-left mr-2"></i>Inventario
                    </button>
                    <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 btn">
                        <i class="fas fa-sign-out-alt mr-2"></i>Salir
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Pestañas -->
    <div class="glass-effect rounded-2xl shadow-xl p-2 mb-6 fade-in">
        <div class="flex flex-wrap gap-2">
            <button onclick="switchTab('users')" class="tab-button active px-4 py-2 rounded-lg font-medium" data-tab="users">
                <i class="fas fa-users mr-2"></i>Usuarios
            </button>
            <button onclick="switchTab('assignments')" class="tab-button px-4 py-2 rounded-lg font-medium" data-tab="assignments">
                <i class="fas fa-user-tag mr-2"></i>Asignaciones
            </button>
        </div>
    </div>

    <!-- Contenido -->
    <div class="container mx-auto p-4">
        <!-- Usuarios -->
        <div id="users-tab" class="tab-content">
            <div class="glass-effect rounded-2xl shadow-xl p-6 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Gestión de Usuarios</h2>
                    <button onclick="openUserModal()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 btn">
                        <i class="fas fa-user-plus mr-2"></i>Nuevo Usuario
                    </button>
                </div>
                
                <div id="usersList" class="space-y-4">
                    <!-- Usuarios se cargarán aquí -->
                </div>
            </div>
        </div>

        <!-- Asignaciones -->
        <div id="assignments-tab" class="tab-content hidden">
            <div class="glass-effect rounded-2xl shadow-xl p-6 fade-in">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Asignar Empleados a Tiendas</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Empleados Disponibles -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Empleados Disponibles</h3>
                        <div id="availableEmployees" class="space-y-3">
                            <!-- Empleados se cargarán aquí -->
                        </div>
                    </div>
                    
                    <!-- Asignaciones Actuales -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Asignaciones Actuales</h3>
                        <div id="currentAssignments" class="space-y-3">
                            <!-- Asignaciones se cargarán aquí -->
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        Los empleados solo pueden acceder a las tiendas que les han sido asignadas. 
                        Los administradores pueden acceder a todas las tiendas.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Usuario -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800" id="modalTitle">Nuevo Usuario</h2>
                <button onclick="closeUserModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="userForm" onsubmit="saveUser(event)" class="space-y-4">
                <input type="hidden" id="userId">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                        <input type="text" id="userName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Usuario *</label>
                        <input type="text" id="userUsername" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contraseña *</label>
                    <input type="password" id="userPassword" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Rol *</label>
                    <select id="userRole" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="">Seleccionar rol</option>
                        <option value="admin">Administrador</option>
                        <option value="employee">Empleado</option>
                    </select>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 btn">
                        <i class="fas fa-save mr-2"></i>Guardar
                    </button>
                    <button type="button" onclick="closeUserModal()" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 btn">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notificación -->
    <div id="notification" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-4 flex items-center gap-3 min-w-[300px]">
            <div id="notificationIcon"></div>
            <div>
                <div id="notificationTitle" class="font-semibold text-gray-800"></div>
                <div id="notificationMessage" class="text-sm text-gray-600"></div>
            </div>
        </div>
    </div>

    <script>
        // Estado Global
        let currentUser = null;
        let users = [];
        let stores = [];
        let assignments = {};

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadUsers();
            loadStores();
            loadAssignments();
            
            // Cargar la primera pestaña
            switchTab('users');
        });

        // Autenticación
        function checkAuth() {
            const user = localStorage.getItem('currentUser');
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = JSON.parse(user);
            if (currentUser.role !== 'admin') {
                window.location.href = 'index.html';
                return;
            }
        }

        function logout() {
            if (confirm('¿Estás seguro de que deseas salir?')) {
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            }
        }

        // Gestión de Pestañas
        function switchTab(tabName) {
            // Ocultar todas las pestañas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Mostrar la pestaña seleccionada
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Actualizar botones
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Cargar datos específicos de la pestaña
            if (tabName === 'users') {
                renderUsers();
            } else if (tabName === 'assignments') {
                renderAssignments();
            }
        }

        // Gestión de Usuarios
        function loadUsers() {
            const usersData = localStorage.getItem('users');
            if (usersData) {
                users = JSON.parse(usersData);
            } else {
                // Usuarios por defecto
                users = [
                    {
                        id: '1',
                        name: 'Administrador',
                        username: 'admin',
                        password: 'admin123',
                        role: 'admin'
                    },
                    {
                        id: '2',
                        name: 'Vendedor 1',
                        username: 'vendedor1',
                        password: 'empleado',
                        role: 'employee'
                    }
                ];
                saveUsers();
            }
        }

        function saveUsers() {
            localStorage.setItem('users', JSON.stringify(users));
        }

        function renderUsers() {
            const usersList = document.getElementById('usersList');
            
            if (users.length === 0) {
                usersList.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-users text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">No hay usuarios</h3>
                        <p class="text-gray-500">Crea el primer usuario para comenzar</p>
                    </div>
                `;
                return;
            }

            usersList.innerHTML = users.map(user => {
                const roleClass = user.role === 'admin' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800';
                const roleText = user.role === 'admin' ? 'Administrador' : 'Empleado';
                
                return `
                    <div class="bg-white rounded-lg p-4 shadow-md employee-card">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-purple-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-800">${user.name}</h3>
                                    <p class="text-sm text-gray-600">@${user.username}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="px-3 py-1 rounded-full text-xs font-medium ${roleClass}">
                                    ${roleText}
                                </span>
                                <div class="flex gap-2">
                                    <button onclick="editUser('${user.id}')" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 btn text-sm">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ${user.id !== '1' ? `
                                        <button onclick="deleteUser('${user.id}')" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 btn text-sm">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openUserModal() {
            document.getElementById('modalTitle').textContent = 'Nuevo Usuario';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('userModal').style.display = 'block';
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        function saveUser(event) {
            event.preventDefault();
            
            const userId = document.getElementById('userId').value;
            const name = document.getElementById('userName').value.trim();
            const username = document.getElementById('userUsername').value.trim();
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;

            // Validar que no exista un usuario con el mismo username (excepto si es edición)
            const existingUser = users.find(u => u.username === username && u.id !== userId);
            if (existingUser) {
                showNotification('error', 'Error', 'Ya existe un usuario con este nombre de usuario');
                return;
            }

            if (userId) {
                // Editar usuario existente
                const index = users.findIndex(u => u.id === userId);
                if (index !== -1) {
                    users[index] = {
                        ...users[index],
                        name,
                        username,
                        password: password || users[index].password,
                        role
                    };
                }
                showNotification('success', 'Usuario Actualizado', 'El usuario ha sido actualizado correctamente');
            } else {
                // Crear nuevo usuario
                const newUser = {
                    id: Date.now().toString(),
                    name,
                    username,
                    password,
                    role,
                    createdAt: new Date().toISOString()
                };
                users.push(newUser);
                showNotification('success', 'Usuario Creado', 'El usuario ha sido creado correctamente');
            }

            saveUsers();
            renderUsers();
            closeUserModal();
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('modalTitle').textContent = 'Editar Usuario';
            document.getElementById('userId').value = user.id;
            document.getElementById('userName').value = user.name;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userPassword').value = user.password;
            document.getElementById('userRole').value = user.role;
            
            document.getElementById('userModal').style.display = 'block';
        }

        function deleteUser(userId) {
            if (!confirm('¿Estás seguro de que deseas eliminar este usuario?')) return;
            
            const index = users.findIndex(u => u.id === userId);
            if (index !== -1) {
                users.splice(index, 1);
                saveUsers();
                renderUsers();
                showNotification('success', 'Usuario Eliminado', 'El usuario ha sido eliminado correctamente');
            }
        }

        // Gestión de Tiendas
        function loadStores() {
            stores = [
                {
                    id: 'la_estancia',
                    name: 'La Estancia',
                    address: 'Avenia Caracas 70A - 89',
                    sector: 'Caracas'
                },
                {
                    id: 'animal_world',
                    name: 'Animal World',
                    address: 'Calle 58 #127-88',
                    sector: 'Norte'
                }
            ];
        }

        // Gestión de Asignaciones
        function loadAssignments() {
            const assignmentsData = localStorage.getItem('userAssignments');
            if (assignmentsData) {
                assignments = JSON.parse(assignmentsData);
            } else {
                assignments = {};
            }
        }

        function saveAssignments() {
            localStorage.setItem('userAssignments', JSON.stringify(assignments));
        }

        function renderAssignments() {
            renderAvailableEmployees();
            renderCurrentAssignments();
        }

        function renderAvailableEmployees() {
            const container = document.getElementById('availableEmployees');
            const employees = users.filter(u => u.role === 'employee');
            
            if (employees.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-user-slash text-4xl mb-2"></i>
                        <p>No hay empleados disponibles</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = employees.map(employee => {
                const assignedStores = assignments[employee.id] || [];
                
                return `
                    <div class="bg-white rounded-lg p-4 shadow-md">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-blue-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800">${employee.name}</h4>
                                    <p class="text-sm text-gray-600">@${employee.username}</p>
                                </div>
                            </div>
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">
                                Empleado
                            </span>
                        </div>
                        
                        <div class="space-y-2">
                            <p class="text-sm font-medium text-gray-700">Tiendas asignadas:</p>
                            ${stores.map(store => `
                                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                                    <input type="checkbox" 
                                           class="assignment-checkbox"
                                           value="${store.id}"
                                           ${assignedStores.includes(store.id) ? 'checked' : ''}
                                           onchange="toggleAssignment('${employee.id}', '${store.id}')">
                                    <span class="text-sm">${store.name}</span>
                                </label>
                            `).join('')}
                        </div>
                        
                        <div class="mt-3 text-xs text-gray-500">
                            ${assignedStores.length} tienda(s) asignada(s)
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCurrentAssignments() {
            const container = document.getElementById('currentAssignments');
            
            if (Object.keys(assignments).length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-link text-4xl mb-2"></i>
                        <p>No hay asignaciones registradas</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = stores.map(store => {
                const assignedEmployees = Object.keys(assignments)
                    .filter(userId => assignments[userId].includes(store.id))
                    .map(userId => users.find(u => u.id === userId))
                    .filter(Boolean);

                return `
                    <div class="bg-white rounded-lg p-4 shadow-md">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-store text-purple-600"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">${store.name}</h4>
                                <p class="text-sm text-gray-600">${store.address}</p>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            ${assignedEmployees.length > 0 ? `
                                ${assignedEmployees.map(employee => `
                                    <div class="flex items-center justify-between bg-gray-50 p-2 rounded">
                                        <span class="text-sm">${employee.name}</span>
                                        <button onclick="removeAssignment('${employee.id}', '${store.id}')" 
                                                class="text-red-500 hover:text-red-700 text-sm">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            ` : `
                                <p class="text-sm text-gray-500">Sin empleados asignados</p>
                            `}
                        </div>
                        
                        <div class="mt-3 text-xs text-gray-500">
                            ${assignedEmployees.length} empleado(s) asignado(s)
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleAssignment(userId, storeId) {
            if (!assignments[userId]) {
                assignments[userId] = [];
            }

            const index = assignments[userId].indexOf(storeId);
            if (index > -1) {
                assignments[userId].splice(index, 1);
                showNotification('info', 'Asignación Removida', 'El empleado ya no tiene acceso a esta tienda');
            } else {
                assignments[userId].push(storeId);
                showNotification('success', 'Asignación Agregada', 'El empleado ahora tiene acceso a esta tienda');
            }

            saveAssignments();
            renderAssignments();
        }

        function removeAssignment(userId, storeId) {
            if (!assignments[userId]) return;

            const index = assignments[userId].indexOf(storeId);
            if (index > -1) {
                assignments[userId].splice(index, 1);
                saveAssignments();
                renderAssignments();
                showNotification('info', 'Asignación Removida', 'El empleado ya no tiene acceso a esta tienda');
            }
        }

        // Notificaciones
        function showNotification(type, title, message) {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');

            const icons = {
                success: '<i class="fas fa-check-circle text-green-500 text-xl"></i>',
                error: '<i class="fas fa-exclamation-circle text-red-500 text-xl"></i>',
                info: '<i class="fas fa-info-circle text-blue-500 text-xl"></i>'
            };

            icon.innerHTML = icons[type] || icons.info;
            titleEl.textContent = title;
            messageEl.textContent = message;

            notification.classList.remove('hidden');
            notification.classList.add('fade-in');

            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        // Cerrar modales con ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeUserModal();
            }
        });

        // Cerrar modales haciendo clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('userModal');
            if (event.target === modal) {
                closeUserModal();
            }
        }
    </script>
</body>
</html>