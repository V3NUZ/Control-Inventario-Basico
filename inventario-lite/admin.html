<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Inventario Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .user-card {
            transition: all 0.3s ease;
        }
        
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .badge-role {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-admin {
            background: #ef4444;
            color: white;
        }
        
        .badge-employee {
            background: #3b82f6;
            color: white;
        }
        
        .permission-tag {
            display: inline-block;
            padding: 2px 8px;
            background: #f3f4f6;
            border-radius: 4px;
            font-size: 0.75rem;
            margin: 2px;
        }
        
        .btn-action {
            transition: all 0.2s ease;
        }
        
        .btn-action:hover {
            transform: scale(1.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .debug-panel {
            background: #1f2937;
            color: #10b981;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .debug-line {
            padding: 2px 8px;
            border-bottom: 1px solid #374151;
        }
        
        .debug-error {
            color: #ef4444;
        }
        
        .debug-warning {
            color: #f59e0b;
        }
        
        .debug-success {
            color: #10b981;
        }
        
        .debug-info {
            color: #3b82f6;
        }
        
        .tab-button {
            transition: all 0.2s ease;
        }
        
        .tab-button.active {
            background: #7c3aed;
            color: white;
        }
        
        .store-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .store-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .store-card.selected {
            border: 2px solid #7c3aed;
            background: #f3f4f6;
        }
        
        .assignment-checkbox {
            transition: all 0.2s ease;
        }
        
        .assignment-checkbox:checked {
            background-color: #7c3aed;
            border-color: #7c3aed;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto p-4">
        <!-- Header -->
        <header class="glass-effect rounded-2xl shadow-xl p-6 mb-6 fade-in">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-users-cog text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Panel de Administraci√≥n</h1>
                        <p class="text-gray-600">Gesti√≥n multi-tienda y usuarios</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Indicador de sincronizaci√≥n -->
                    <div id="syncStatus" class="hidden items-center gap-2 px-3 py-2 bg-gray-100 rounded-lg">
                        <div id="syncIcon" class="w-4 h-4"></div>
                        <span id="syncText" class="text-sm text-gray-600"></span>
                    </div>
                    <button onclick="userManager.openDebugPanel()" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition" title="Panel de Depuraci√≥n">
                        <i class="fas fa-bug mr-2"></i>Debug
                    </button>
                    <button onclick="window.location.href='index.html'" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                        <i class="fas fa-arrow-left mr-2"></i>Inventario
                    </button>
                    <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                        <i class="fas fa-sign-out-alt mr-2"></i>Salir
                    </button>
                </div>
            </div>
        </header>

        <!-- Pesta√±as de Navegaci√≥n -->
        <div class="glass-effect rounded-2xl shadow-xl p-2 mb-6 fade-in">
            <div class="flex flex-wrap gap-2">
                <button onclick="userManager.switchTab('dashboard')" class="tab-button active px-4 py-2 rounded-lg font-medium" data-tab="dashboard">
                    <i class="fas fa-chart-line mr-2"></i>Dashboard
                </button>
                <button onclick="userManager.switchTab('users')" class="tab-button px-4 py-2 rounded-lg font-medium" data-tab="users">
                    <i class="fas fa-users mr-2"></i>Usuarios
                </button>
                <button onclick="userManager.switchTab('stores')" class="tab-button px-4 py-2 rounded-lg font-medium" data-tab="stores">
                    <i class="fas fa-store mr-2"></i>Tiendas
                </button>
                <button onclick="userManager.switchTab('assignments')" class="tab-button px-4 py-2 rounded-lg font-medium" data-tab="assignments">
                    <i class="fas fa-user-tag mr-2"></i>Asignaciones
                </button>
            </div>
        </div>

        <!-- Contenido de Pesta√±as -->
        <div id="tabContent">
            <!-- Dashboard -->
            <div id="dashboard-tab" class="tab-content">
                <!-- Estad√≠sticas -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="glass-effect rounded-xl p-6 text-center fade-in">
                        <div class="text-3xl font-bold text-purple-600" id="totalUsers">0</div>
                        <div class="text-gray-600">Total Usuarios</div>
                    </div>
                    <div class="glass-effect rounded-xl p-6 text-center fade-in">
                        <div class="text-3xl font-bold text-red-600" id="adminCount">0</div>
                        <div class="text-gray-600">Administradores</div>
                    </div>
                    <div class="glass-effect rounded-xl p-6 text-center fade-in">
                        <div class="text-3xl font-bold text-blue-600" id="employeeCount">0</div>
                        <div class="text-gray-600">Empleados</div>
                    </div>
                    <div class="glass-effect rounded-xl p-6 text-center fade-in">
                        <div class="text-3xl font-bold text-green-600" id="storeCount">0</div>
                        <div class="text-gray-600">Tiendas</div>
                    </div>
                </div>

                <!-- Actividad Reciente -->
                <div class="glass-effect rounded-2xl shadow-xl p-6 fade-in">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Actividad Reciente</h2>
                    <div id="recentActivity" class="space-y-3">
                        <!-- La actividad se cargar√° aqu√≠ -->
                    </div>
                </div>
            </div>

            <!-- Usuarios -->
            <div id="users-tab" class="tab-content hidden">
                <div class="glass-effect rounded-2xl shadow-xl p-6 fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Usuarios Registrados</h2>
                        <button onclick="userManager.openUserModal()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                            <i class="fas fa-user-plus mr-2"></i>Nuevo Usuario
                        </button>
                    </div>
                    
                    <div id="usersList" class="space-y-4">
                        <!-- Usuarios se cargar√°n aqu√≠ -->
                    </div>
                    
                    <div id="emptyState" class="text-center py-12 hidden">
                        <i class="fas fa-users text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">No hay usuarios registrados</h3>
                        <p class="text-gray-500">Crea el primer usuario para comenzar</p>
                    </div>
                </div>
            </div>

            <!-- Tiendas -->
            <div id="stores-tab" class="tab-content hidden">
                <div class="glass-effect rounded-2xl shadow-xl p-6 fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Tiendas Registradas</h2>
                        <button onclick="userManager.openStoreModal()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                            <i class="fas fa-store-plus mr-2"></i>Nueva Tienda
                        </button>
                    </div>
                    
                    <div id="storesList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Tiendas se cargar√°n aqu√≠ -->
                    </div>
                </div>
            </div>

            <!-- Asignaciones -->
            <div id="assignments-tab" class="tab-content hidden">
                <div class="glass-effect rounded-2xl shadow-xl p-6 fade-in">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Asignar Empleados a Tiendas</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Empleados Disponibles -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Empleados Disponibles</h3>
                            <div id="availableEmployees" class="space-y-3">
                                <!-- Empleados se cargar√°n aqu√≠ -->
                            </div>
                        </div>
                        
                        <!-- Asignaciones Actuales -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Asignaciones Actuales</h3>
                            <div id="currentAssignments" class="space-y-3">
                                <!-- Asignaciones se cargar√°n aqu√≠ -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            Los empleados solo pueden acceder a las tiendas que les han sido asignadas. 
                            Los administradores pueden acceder a todas las tiendas.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Usuario -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800" id="modalTitle">Nuevo Usuario</h2>
                <button onclick="userManager.closeUserModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="userForm" class="space-y-4">
                <input type="hidden" id="userId">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                        <input type="text" id="userName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Usuario *</label>
                        <input type="text" id="userUsername" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a *</label>
                    <input type="password" id="userPassword" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1">M√≠nimo 6 caracteres</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Rol *</label>
                    <select id="userRole" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">Seleccionar rol</option>
                        <option value="admin">Administrador</option>
                        <option value="employee">Empleado</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Permisos</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="perm_read" checked class="mr-2 rounded text-purple-600">
                            <span>Leer inventario</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="perm_write" class="mr-2 rounded text-purple-600">
                            <span>Editar productos y stock</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="perm_delete" class="mr-2 rounded text-purple-600">
                            <span>Eliminar productos</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="perm_manage_users" class="mr-2 rounded text-purple-600">
                            <span>Gestionar usuarios</span>
                        </label>
                    </div>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                        <i class="fas fa-save mr-2"></i>Guardar Usuario
                    </button>
                    <button type="button" onclick="userManager.closeUserModal()" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Tienda -->
    <div id="storeModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800" id="storeModalTitle">Nueva Tienda</h2>
                <button onclick="userManager.closeStoreModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="storeForm" class="space-y-4">
                <input type="hidden" id="storeId">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de la Tienda *</label>
                    <input type="text" id="storeName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Direcci√≥n *</label>
                    <input type="text" id="storeAddress" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sector/Zona</label>
                    <input type="text" id="storeSector" placeholder="Ej: Centro, Norte, Sur" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tel√©fono</label>
                    <input type="tel" id="storePhone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                        <i class="fas fa-save mr-2"></i>Guardar Tienda
                    </button>
                    <button type="button" onclick="userManager.closeStoreModal()" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Debug -->
    <div id="debugModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Panel de Depuraci√≥n</h2>
                <button onclick="userManager.closeDebugPanel()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Controles de Debug -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <button onclick="userManager.runDiagnostic()" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm">
                    <i class="fas fa-stethoscope mr-1"></i>Diagn√≥stico
                </button>
                <button onclick="userManager.clearAllData()" class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm">
                    <i class="fas fa-trash mr-1"></i>Limpiar Datos
                </button>
                <button onclick="userManager.exportData()" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm">
                    <i class="fas fa-download mr-1"></i>Exportar
                </button>
                <button onclick="userManager.importData()" class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm">
                    <i class="fas fa-upload mr-1"></i>Importar
                </button>
            </div>
            
            <!-- Consola de Debug -->
            <div class="debug-panel rounded-lg p-4" id="debugConsole">
                <!-- La salida de debug aparecer√° aqu√≠ -->
            </div>
            
            <!-- Informaci√≥n del Sistema -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                <div class="bg-gray-100 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-3">Estado del Sistema</h3>
                    <div id="systemStatus" class="space-y-2 text-sm">
                        <!-- Estado del sistema -->
                    </div>
                </div>
                <div class="bg-gray-100 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-3">Estad√≠sticas</h3>
                    <div id="debugStats" class="space-y-2 text-sm">
                        <!-- Estad√≠sticas -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notificaci√≥n -->
    <div id="notification" class="fixed top-4 right-4 bg-white px-6 py-4 rounded-lg shadow-lg border-l-4 border-green-500 hidden z-50">
        <div class="flex items-center">
            <i class="fas fa-check-circle text-green-500 mr-3"></i>
            <span id="notificationText"></span>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="firebase-config-demo.js"></script>
    
    <script>
        /**
         * Sistema de Administraci√≥n Multi-Tienda Funcional
         * 
         * Caracter√≠sticas:
         * - Edici√≥n de usuarios completamente funcional
         * - Asignaci√≥n de empleados a tiendas con checkboxes
         * - Gesti√≥n completa de tiendas
         * - Debug avanzado
         */

        class UserManager {
            constructor() {
                this.users = [];
                this.stores = [];
                this.assignments = {};
                this.editingUser = null;
                this.editingStore = null;
                this.firebaseReady = false;
                this.realtimeListener = null;
                this.currentTab = 'dashboard';
                this.debugLogs = [];
                this.init();
            }

            init() {
                this.checkAdminAccess();
                this.setupFirebaseWaiter();
                this.setupEventListeners();
                this.loadInitialData();
                this.setupAutoSync();
                this.updateSystemStatus();
            }

            // Verificar acceso de administrador
            checkAdminAccess() {
                const currentUser = localStorage.getItem('currentUser');
                if (!currentUser) {
                    window.location.href = 'login.html';
                    return;
                }

                try {
                    const user = JSON.parse(currentUser);
                    if (user.role !== 'admin') {
                        alert('Acceso denegado. Solo los administradores pueden acceder a este panel.');
                        window.location.href = 'index.html';
                        return;
                    }
                } catch (error) {
                    window.location.href = 'login.html';
                    return;
                }
            }

            // Configurar espera de Firebase
            setupFirebaseWaiter() {
                if (window.firebaseReady) {
                    this.onFirebaseReady();
                } else {
                    const checkFirebase = setInterval(() => {
                        if (window.firebaseReady !== undefined) {
                            clearInterval(checkFirebase);
                            this.onFirebaseReady();
                        }
                    }, 100);
                    
                    setTimeout(() => {
                        clearInterval(checkFirebase);
                        if (!window.firebaseReady) {
                            this.logDebug('warn', 'Firebase no inicializado, usando modo offline');
                            this.loadOfflineData();
                        }
                    }, 5000);
                }
            }

            // Firebase listo
            async onFirebaseReady() {
                if (!window.firebaseReady || !window.database) {
                    this.logDebug('warn', 'Firebase no disponible, usando modo offline');
                    this.loadOfflineData();
                    return;
                }

                this.firebaseReady = true;
                this.logDebug('success', 'üî• Firebase conectado correctamente');
                await this.loadFromFirebase();
            }

            // Cargar datos iniciales
            async loadInitialData() {
                await this.loadUsers();
                await this.loadStores();
                await this.loadAssignments();
                this.renderCurrentTab();
                this.updateStats();
            }

            // Cargar usuarios
            async loadUsers() {
                try {
                    // Primero cargar desde localStorage
                    const localUsers = localStorage.getItem('inventario_users');
                    if (localUsers) {
                        this.users = JSON.parse(localUsers);
                    }
                    
                    // Si no hay usuarios, crear los por defecto
                    if (this.users.length === 0) {
                        this.users = [
                            {
                                id: 'admin_default',
                                name: 'Administrador',
                                username: 'admin',
                                password: 'admin123',
                                role: 'admin',
                                permissions: {
                                    read: true,
                                    write: true,
                                    delete: true,
                                    manage_users: true
                                },
                                createdAt: new Date().toISOString(),
                                lastLogin: new Date().toISOString()
                            },
                            {
                                id: 'employee_1',
                                name: 'Vendedor 1',
                                username: 'vendedor1',
                                password: 'empleado',
                                role: 'employee',
                                permissions: {
                                    read: true,
                                    write: true,
                                    delete: false,
                                    manage_users: false
                                },
                                createdAt: new Date().toISOString(),
                                lastLogin: null
                            }
                        ];
                        await this.saveUsers();
                    }
                    
                    // Si Firebase est√° disponible, sincronizar
                    if (this.firebaseReady && window.database) {
                        const snapshot = await window.database.ref('users').once('value');
                        const data = snapshot.val();
                        if (data && data.data) {
                            this.users = data.data;
                            localStorage.setItem('inventario_users', JSON.stringify(this.users));
                        }
                    }
                    
                    this.logDebug('info', `üì• ${this.users.length} usuarios cargados`);
                } catch (error) {
                    this.logDebug('error', `‚ùå Error cargando usuarios: ${error.message}`);
                    this.loadOfflineUsers();
                }
            }

            // Cargar tiendas
            async loadStores() {
                try {
                    // Primero cargar desde localStorage
                    const localStores = localStorage.getItem('inventario_stores');
                    if (localStores) {
                        this.stores = JSON.parse(localStores);
                    }
                    
                    // Si no hay tiendas, crear las por defecto
                    if (this.stores.length === 0) {
                        this.stores = [
                            {
                                id: 'store_1',
                                name: 'La Estancia',
                                address: 'Avenia Caracas 70A - 89',
                                sector: 'Tienda sector Caracas',
                                phone: '',
                                products: 0,
                                units: 0,
                                needs: 0
                            },
                            {
                                id: 'store_2',
                                name: 'Animal World',
                                address: 'Calle 58 #127-88',
                                sector: 'Tienda del sector norte',
                                phone: '',
                                products: 0,
                                units: 0,
                                needs: 0
                            }
                        ];
                        await this.saveStores();
                    }
                    
                    // Si Firebase est√° disponible, sincronizar
                    if (this.firebaseReady && window.database) {
                        const snapshot = await window.database.ref('stores').once('value');
                        const data = snapshot.val();
                        if (data && data.data) {
                            this.stores = data.data;
                            localStorage.setItem('inventario_stores', JSON.stringify(this.stores));
                        }
                    }
                    
                    this.logDebug('info', `üè™ ${this.stores.length} tiendas cargadas`);
                } catch (error) {
                    this.logDebug('error', `‚ùå Error cargando tiendas: ${error.message}`);
                }
            }

            // Cargar asignaciones
            async loadAssignments() {
                try {
                    let assignments = {};
                    
                    // Cargar desde localStorage
                    const localAssignments = localStorage.getItem('inventario_assignments');
                    if (localAssignments) {
                        assignments = JSON.parse(localAssignments);
                    }
                    
                    // Si Firebase est√° disponible, sincronizar
                    if (this.firebaseReady && window.database) {
                        const snapshot = await window.database.ref('assignments').once('value');
                        const data = snapshot.val();
                        if (data && data.data) {
                            assignments = data.data;
                            localStorage.setItem('inventario_assignments', JSON.stringify(assignments));
                        }
                    }
                    
                    this.assignments = assignments || {};
                    this.logDebug('info', `üë• ${Object.keys(this.assignments).length} asignaciones cargadas`);
                } catch (error) {
                    this.logDebug('error', `‚ùå Error cargando asignaciones: ${error.message}`);
                    this.assignments = {};
                }
            }

            // Cargar datos offline
            loadOfflineData() {
                this.loadOfflineUsers();
                this.loadOfflineStores();
                this.loadOfflineAssignments();
            }

            loadOfflineUsers() {
                const localUsers = localStorage.getItem('inventario_users');
                if (localUsers) {
                    this.users = JSON.parse(localUsers);
                }
                if (this.users.length === 0) {
                    this.users = [
                        {
                            id: 'admin_default',
                            name: 'Administrador',
                            username: 'admin',
                            password: 'admin123',
                            role: 'admin',
                            permissions: {
                                read: true,
                                write: true,
                                delete: true,
                                manage_users: true
                            },
                            createdAt: new Date().toISOString(),
                            lastLogin: new Date().toISOString()
                        }
                    ];
                    this.saveUsers();
                }
            }

            loadOfflineStores() {
                const localStores = localStorage.getItem('inventario_stores');
                if (localStores) {
                    this.stores = JSON.parse(localStores);
                }
                if (this.stores.length === 0) {
                    this.stores = [
                        {
                            id: 'store_1',
                            name: 'La Estancia',
                            address: 'Avenia Caracas 70A - 89',
                            sector: 'Tienda sector Caracas',
                            phone: '',
                            products: 0,
                            units: 0,
                            needs: 0
                        },
                        {
                            id: 'store_2',
                            name: 'Animal World',
                            address: 'Calle 58 #127-88',
                            sector: 'Tienda del sector norte',
                            phone: '',
                            products: 0,
                            units: 0,
                            needs: 0
                        }
                    ];
                    this.saveStores();
                }
            }

            loadOfflineAssignments() {
                const localAssignments = localStorage.getItem('inventario_assignments');
                if (localAssignments) {
                    this.assignments = JSON.parse(localAssignments);
                }
            }

            // Configurar event listeners
            setupEventListeners() {
                // Formulario de usuario
                document.getElementById('userForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveUser();
                });

                // Formulario de tienda
                document.getElementById('storeForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveStore();
                });

                // Cerrar modales al hacer clic fuera
                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        e.target.style.display = 'none';
                    }
                });
            }

            // Cambiar pesta√±a
            switchTab(tabName) {
                // Actualizar botones
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // Actualizar contenido
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${tabName}-tab`).classList.remove('hidden');

                this.currentTab = tabName;
                this.renderCurrentTab();
            }

            // Renderizar pesta√±a actual
            renderCurrentTab() {
                switch (this.currentTab) {
                    case 'dashboard':
                        this.renderDashboard();
                        break;
                    case 'users':
                        this.renderUsers();
                        break;
                    case 'stores':
                        this.renderStores();
                        break;
                    case 'assignments':
                        this.renderAssignments();
                        break;
                }
            }

            // Renderizar dashboard
            renderDashboard() {
                this.updateStats();
                this.renderRecentActivity();
            }

            // Renderizar usuarios
            renderUsers() {
                const usersList = document.getElementById('usersList');
                const emptyState = document.getElementById('emptyState');

                if (this.users.length === 0) {
                    usersList.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }

                emptyState.classList.add('hidden');
                usersList.innerHTML = this.users.map(user => `
                    <div class="user-card bg-white rounded-lg p-4 shadow-md">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-user text-purple-600"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-gray-800">${user.name}</h3>
                                        <p class="text-sm text-gray-600">@${user.username}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="badge-role ${user.role === 'admin' ? 'badge-admin' : 'badge-employee'}">
                                        ${user.role === 'admin' ? 'Administrador' : 'Empleado'}
                                    </span>
                                    ${user.lastLogin ? `<span class="text-xs text-gray-500">√öltimo login: ${new Date(user.lastLogin).toLocaleDateString()}</span>` : ''}
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    ${Object.entries(user.permissions || {}).map(([perm, enabled]) => 
                                        enabled ? `<span class="permission-tag">${this.getPermissionLabel(perm)}</span>` : ''
                                    ).join('')}
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="userManager.editUser('${user.id}')" class="btn-action p-2 text-blue-600 hover:bg-blue-50 rounded-lg">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="userManager.deleteUser('${user.id}')" class="btn-action p-2 text-red-600 hover:bg-red-50 rounded-lg">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Renderizar tiendas
            renderStores() {
                const storesList = document.getElementById('storesList');
                
                if (this.stores.length === 0) {
                    storesList.innerHTML = '<div class="col-span-2 text-center py-8 text-gray-500">No hay tiendas registradas</div>';
                    return;
                }

                storesList.innerHTML = this.stores.map(store => `
                    <div class="store-card bg-white rounded-lg p-6 shadow-md">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">${store.name}</h3>
                                <p class="text-sm text-gray-600">${store.address}</p>
                                ${store.sector ? `<p class="text-xs text-gray-500">${store.sector}</p>` : ''}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="userManager.editStore('${store.id}')" class="btn-action p-2 text-blue-600 hover:bg-blue-50 rounded-lg">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="userManager.deleteStore('${store.id}')" class="btn-action p-2 text-red-600 hover:bg-red-50 rounded-lg">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-purple-600">${store.products || 0}</div>
                                <div class="text-xs text-gray-600">Productos</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600">${store.units || 0}</div>
                                <div class="text-xs text-gray-600">Unidades</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-orange-600">${store.needs || 0}</div>
                                <div class="text-xs text-gray-600">Necesitan</div>
                            </div>
                        </div>
                        
                        <button onclick="window.location.href='index.html?store=${store.id}'" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                            <i class="fas fa-box mr-2"></i>Gestionar Inventario
                        </button>
                    </div>
                `).join('');
            }

            // Renderizar asignaciones
            renderAssignments() {
                this.renderAvailableEmployees();
                this.renderCurrentAssignments();
            }

            // Renderizar empleados disponibles
            renderAvailableEmployees() {
                const availableEmployees = document.getElementById('availableEmployees');
                const employees = this.users.filter(user => user.role === 'employee');
                
                if (employees.length === 0) {
                    availableEmployees.innerHTML = '<div class="text-center py-8 text-gray-500">No hay empleados disponibles</div>';
                    return;
                }

                availableEmployees.innerHTML = employees.map(employee => `
                    <div class="bg-white rounded-lg p-4 shadow-md">
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <h4 class="font-semibold text-gray-800">${employee.name}</h4>
                                <p class="text-sm text-gray-600">@${employee.username}</p>
                            </div>
                            <span class="badge-role badge-employee">Empleado</span>
                        </div>
                        
                        <div class="mb-3">
                            <p class="text-sm font-medium text-gray-700 mb-2">Asignar a tiendas:</p>
                            <div class="space-y-2">
                                ${this.stores.map(store => `
                                    <label class="flex items-center">
                                        <input type="checkbox" 
                                               class="assignment-checkbox mr-2 rounded text-purple-600"
                                               onchange="userManager.toggleAssignment('${employee.id}', '${store.id}', this.checked)"
                                               ${this.assignments[employee.id]?.includes(store.id) ? 'checked' : ''}>
                                        <span class="text-sm">${store.name}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="text-xs text-gray-500">
                            Asignado a ${this.assignments[employee.id]?.length || 0} tiendas
                        </div>
                    </div>
                `).join('');
            }

            // Renderizar asignaciones actuales
            renderCurrentAssignments() {
                const currentAssignments = document.getElementById('currentAssignments');
                
                if (Object.keys(this.assignments).length === 0) {
                    currentAssignments.innerHTML = '<div class="text-center py-8 text-gray-500">No hay asignaciones registradas</div>';
                    return;
                }

                currentAssignments.innerHTML = Object.entries(this.assignments).map(([userId, storeIds]) => {
                    const user = this.users.find(u => u.id === userId);
                    if (!user || user.role !== 'employee') return '';
                    
                    const assignedStores = storeIds.map(storeId => 
                        this.stores.find(s => s.id === storeId)
                    ).filter(Boolean);
                    
                    return `
                        <div class="bg-white rounded-lg p-4 shadow-md">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold text-gray-800">${user.name}</h4>
                                <span class="text-xs text-gray-500">${assignedStores.length} tiendas</span>
                            </div>
                            <div class="space-y-1">
                                ${assignedStores.map(store => `
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-gray-700">${store.name}</span>
                                        <button onclick="userManager.removeAssignment('${userId}', '${store.id}')" 
                                                class="text-red-600 hover:text-red-800">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                `).join('')}
                                ${assignedStores.length === 0 ? '<span class="text-sm text-gray-500">Sin tiendas asignadas</span>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Renderizar actividad reciente
            renderRecentActivity() {
                const recentActivity = document.getElementById('recentActivity');
                
                const activities = [
                    { icon: 'fa-user-plus', text: 'Nuevo usuario registrado', time: 'Hace 2 horas', color: 'text-green-600' },
                    { icon: 'fa-store', text: 'Tienda actualizada', time: 'Hace 5 horas', color: 'text-blue-600' },
                    { icon: 'fa-user-tag', text: 'Empleado asignado a tienda', time: 'Ayer', color: 'text-purple-600' },
                    { icon: 'fa-sign-in-alt', text: 'Inicio de sesi√≥n', time: 'Ayer', color: 'text-gray-600' }
                ];
                
                recentActivity.innerHTML = activities.map(activity => `
                    <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                        <i class="fas ${activity.icon} ${activity.color}"></i>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-800">${activity.text}</p>
                            <p class="text-xs text-gray-500">${activity.time}</p>
                        </div>
                    </div>
                `).join('');
            }

            // Actualizar estad√≠sticas
            updateStats() {
                document.getElementById('totalUsers').textContent = this.users.length;
                document.getElementById('adminCount').textContent = this.users.filter(u => u.role === 'admin').length;
                document.getElementById('employeeCount').textContent = this.users.filter(u => u.role === 'employee').length;
                document.getElementById('storeCount').textContent = this.stores.length;
            }

            // Abrir modal de usuario
            openUserModal() {
                document.getElementById('userModal').style.display = 'block';
                document.getElementById('modalTitle').textContent = 'Nuevo Usuario';
                document.getElementById('userForm').reset();
                document.getElementById('userId').value = '';
                this.editingUser = null;
            }

            // Cerrar modal de usuario
            closeUserModal() {
                document.getElementById('userModal').style.display = 'none';
                this.editingUser = null;
            }

            // Editar usuario
            editUser(userId) {
                const user = this.users.find(u => u.id === userId);
                if (!user) return;

                this.editingUser = user;
                document.getElementById('modalTitle').textContent = 'Editar Usuario';
                document.getElementById('userId').value = user.id;
                document.getElementById('userName').value = user.name;
                document.getElementById('userUsername').value = user.username;
                document.getElementById('userPassword').value = user.password;
                document.getElementById('userRole').value = user.role;
                
                // Establecer permisos
                Object.entries(user.permissions || {}).forEach(([perm, enabled]) => {
                    const checkbox = document.getElementById(`perm_${perm}`);
                    if (checkbox) checkbox.checked = enabled;
                });
                
                document.getElementById('userModal').style.display = 'block';
            }

            // Guardar usuario
            async saveUser() {
                const userId = document.getElementById('userId').value;
                const userData = {
                    name: document.getElementById('userName').value,
                    username: document.getElementById('userUsername').value,
                    password: document.getElementById('userPassword').value,
                    role: document.getElementById('userRole').value,
                    permissions: {
                        read: document.getElementById('perm_read').checked,
                        write: document.getElementById('perm_write').checked,
                        delete: document.getElementById('perm_delete').checked,
                        manage_users: document.getElementById('perm_manage_users').checked
                    }
                };

                if (userId) {
                    // Editar usuario existente
                    const index = this.users.findIndex(u => u.id === userId);
                    if (index !== -1) {
                        this.users[index] = { ...this.users[index], ...userData };
                        this.logDebug('info', `‚úÖ Usuario "${userData.name}" actualizado`);
                    }
                } else {
                    // Crear nuevo usuario
                    const newUser = {
                        id: 'user_' + Date.now(),
                        ...userData,
                        createdAt: new Date().toISOString()
                    };
                    this.users.push(newUser);
                    this.logDebug('info', `‚úÖ Usuario "${userData.name}" creado`);
                }

                await this.saveUsers();
                this.closeUserModal();
                this.renderUsers();
                this.updateStats();
                this.showNotification('Usuario guardado correctamente');
            }

            // Eliminar usuario
            async deleteUser(userId) {
                if (!confirm('¬øEst√°s seguro de eliminar este usuario?')) return;
                
                const user = this.users.find(u => u.id === userId);
                if (!user) return;
                
                this.users = this.users.filter(u => u.id !== userId);
                
                // Eliminar asignaciones del usuario
                delete this.assignments[userId];
                
                await this.saveUsers();
                await this.saveAssignments();
                this.renderUsers();
                this.updateStats();
                this.logDebug('info', `üóëÔ∏è Usuario "${user.name}" eliminado`);
                this.showNotification('Usuario eliminado correctamente');
            }

            // Abrir modal de tienda
            openStoreModal() {
                document.getElementById('storeModal').style.display = 'block';
                document.getElementById('storeModalTitle').textContent = 'Nueva Tienda';
                document.getElementById('storeForm').reset();
                document.getElementById('storeId').value = '';
                this.editingStore = null;
            }

            // Cerrar modal de tienda
            closeStoreModal() {
                document.getElementById('storeModal').style.display = 'none';
                this.editingStore = null;
            }

            // Editar tienda
            editStore(storeId) {
                const store = this.stores.find(s => s.id === storeId);
                if (!store) return;

                this.editingStore = store;
                document.getElementById('storeModalTitle').textContent = 'Editar Tienda';
                document.getElementById('storeId').value = store.id;
                document.getElementById('storeName').value = store.name;
                document.getElementById('storeAddress').value = store.address;
                document.getElementById('storeSector').value = store.sector || '';
                document.getElementById('storePhone').value = store.phone || '';
                
                document.getElementById('storeModal').style.display = 'block';
            }

            // Guardar tienda
            async saveStore() {
                const storeId = document.getElementById('storeId').value;
                const storeData = {
                    name: document.getElementById('storeName').value,
                    address: document.getElementById('storeAddress').value,
                    sector: document.getElementById('storeSector').value,
                    phone: document.getElementById('storePhone').value,
                    products: 0,
                    units: 0,
                    needs: 0
                };

                if (storeId) {
                    // Editar tienda existente
                    const index = this.stores.findIndex(s => s.id === storeId);
                    if (index !== -1) {
                        this.stores[index] = { ...this.stores[index], ...storeData };
                        this.logDebug('info', `‚úÖ Tienda "${storeData.name}" actualizada`);
                    }
                } else {
                    // Crear nueva tienda
                    const newStore = {
                        id: 'store_' + Date.now(),
                        ...storeData
                    };
                    this.stores.push(newStore);
                    this.logDebug('info', `‚úÖ Tienda "${storeData.name}" creada`);
                }

                await this.saveStores();
                this.closeStoreModal();
                this.renderStores();
                this.updateStats();
                this.showNotification('Tienda guardada correctamente');
            }

            // Eliminar tienda
            async deleteStore(storeId) {
                if (!confirm('¬øEst√°s seguro de eliminar esta tienda?')) return;
                
                const store = this.stores.find(s => s.id === storeId);
                if (!store) return;
                
                this.stores = this.stores.filter(s => s.id !== storeId);
                
                // Eliminar asignaciones de esta tienda
                Object.keys(this.assignments).forEach(userId => {
                    this.assignments[userId] = this.assignments[userId].filter(id => id !== storeId);
                    if (this.assignments[userId].length === 0) {
                        delete this.assignments[userId];
                    }
                });
                
                await this.saveStores();
                await this.saveAssignments();
                this.renderStores();
                this.updateStats();
                this.logDebug('info', `üóëÔ∏è Tienda "${store.name}" eliminada`);
                this.showNotification('Tienda eliminada correctamente');
            }

            // Toggle asignaci√≥n
            async toggleAssignment(userId, storeId, enabled) {
                if (!this.assignments[userId]) {
                    this.assignments[userId] = [];
                }
                
                if (enabled) {
                    if (!this.assignments[userId].includes(storeId)) {
                        this.assignments[userId].push(storeId);
                    }
                } else {
                    this.assignments[userId] = this.assignments[userId].filter(id => id !== storeId);
                    if (this.assignments[userId].length === 0) {
                        delete this.assignments[userId];
                    }
                }
                
                await this.saveAssignments();
                this.renderAssignments();
                this.logDebug('info', `üîÑ Asignaci√≥n actualizada: ${userId} -> ${storeId} (${enabled ? 'asignado' : 'removido'})`);
            }

            // Remover asignaci√≥n
            async removeAssignment(userId, storeId) {
                if (this.assignments[userId]) {
                    this.assignments[userId] = this.assignments[userId].filter(id => id !== storeId);
                    if (this.assignments[userId].length === 0) {
                        delete this.assignments[userId];
                    }
                }
                
                await this.saveAssignments();
                this.renderAssignments();
                this.logDebug('info', `üö´ Asignaci√≥n removida: ${userId} -> ${storeId}`);
            }

            // Guardar usuarios
            async saveUsers() {
                try {
                    localStorage.setItem('inventario_users', JSON.stringify(this.users));
                    
                    if (this.firebaseReady) {
                        await window.database.ref('users').set({
                            data: this.users,
                            lastUpdated: new Date().toISOString()
                        });
                    }
                } catch (error) {
                    this.logDebug('error', `‚ùå Error guardando usuarios: ${error.message}`);
                }
            }

            // Guardar tiendas
            async saveStores() {
                try {
                    localStorage.setItem('inventario_stores', JSON.stringify(this.stores));
                    
                    if (this.firebaseReady) {
                        await window.database.ref('stores').set({
                            data: this.stores,
                            lastUpdated: new Date().toISOString()
                        });
                    }
                } catch (error) {
                    this.logDebug('error', `‚ùå Error guardando tiendas: ${error.message}`);
                }
            }

            // Guardar asignaciones
            async saveAssignments() {
                try {
                    localStorage.setItem('inventario_assignments', JSON.stringify(this.assignments));
                    
                    if (this.firebaseReady) {
                        await window.database.ref('assignments').set({
                            data: this.assignments,
                            lastUpdated: new Date().toISOString()
                        });
                    }
                } catch (error) {
                    this.logDebug('error', `‚ùå Error guardando asignaciones: ${error.message}`);
                }
            }

            // Cargar desde Firebase
            async loadFromFirebase() {
                await Promise.all([
                    this.loadUsers(),
                    this.loadStores(),
                    this.loadAssignments()
                ]);
                this.setupRealtimeListener();
            }

            // Configurar listener en tiempo real
            setupRealtimeListener() {
                if (!this.firebaseReady || !window.database) return;
                
                // Listener para usuarios
                window.database.ref('users').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.data) {
                        this.users = data.data;
                        localStorage.setItem('inventario_users', JSON.stringify(this.users));
                        if (this.currentTab === 'users') {
                            this.renderUsers();
                        }
                        this.updateStats();
                        this.logDebug('info', 'üîÑ Usuarios sincronizados desde Firebase');
                    }
                });
                
                // Listener para tiendas
                window.database.ref('stores').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.data) {
                        this.stores = data.data;
                        localStorage.setItem('inventario_stores', JSON.stringify(this.stores));
                        if (this.currentTab === 'stores') {
                            this.renderStores();
                        }
                        this.updateStats();
                        this.logDebug('info', 'üîÑ Tiendas sincronizadas desde Firebase');
                    }
                });
                
                // Listener para asignaciones
                window.database.ref('assignments').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.data) {
                        this.assignments = data.data;
                        localStorage.setItem('inventario_assignments', JSON.stringify(this.assignments));
                        if (this.currentTab === 'assignments') {
                            this.renderAssignments();
                        }
                        this.logDebug('info', 'üîÑ Asignaciones sincronizadas desde Firebase');
                    }
                });
            }

            // Configurar auto-sync
            setupAutoSync() {
                setInterval(() => {
                    if (this.firebaseReady) {
                        this.updateSyncStatus('cloud', 'Sincronizado con Firebase');
                    } else {
                        this.updateSyncStatus('offline', 'Modo offline');
                    }
                }, 30000);
            }

            // Actualizar estado de sincronizaci√≥n
            updateSyncStatus(status, message) {
                const syncStatus = document.getElementById('syncStatus');
                const syncIcon = document.getElementById('syncIcon');
                const syncText = document.getElementById('syncText');

                if (!syncStatus || !syncIcon || !syncText) return;

                syncStatus.classList.remove('hidden');
                syncStatus.classList.add('flex');

                switch (status) {
                    case 'cloud':
                        syncIcon.innerHTML = '<i class="fas fa-cloud text-green-500"></i>';
                        syncText.textContent = message;
                        syncStatus.className = 'flex items-center gap-2 px-3 py-2 bg-green-100 rounded-lg';
                        break;
                    case 'syncing':
                        syncIcon.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-500"></i>';
                        syncText.textContent = message;
                        syncStatus.className = 'flex items-center gap-2 px-3 py-2 bg-blue-100 rounded-lg';
                        break;
                    case 'offline':
                        syncIcon.innerHTML = '<i class="fas fa-wifi-slash text-orange-500"></i>';
                        syncText.textContent = message;
                        syncStatus.className = 'flex items-center gap-2 px-3 py-2 bg-orange-100 rounded-lg';
                        break;
                    case 'error':
                        syncIcon.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500"></i>';
                        syncText.textContent = message;
                        syncStatus.className = 'flex items-center gap-2 px-3 py-2 bg-red-100 rounded-lg';
                        break;
                }
            }

            // PANEL DE DEBUG AVANZADO
            openDebugPanel() {
                document.getElementById('debugModal').style.display = 'block';
                this.runDiagnostic();
                this.updateSystemStatus();
                this.updateDebugStats();
            }

            closeDebugPanel() {
                document.getElementById('debugModal').style.display = 'none';
            }

            // Ejecutar diagn√≥stico completo
            async runDiagnostic() {
                this.clearDebugConsole();
                this.logDebug('info', 'üîç INICIANDO DIAGN√ìSTICO COMPLETO DEL SISTEMA');
                this.logDebug('info', '=' .repeat(50));
                
                // 1. Verificar Firebase
                this.logDebug('info', 'üì° Verificando conexi√≥n Firebase...');
                if (this.firebaseReady && window.database) {
                    this.logDebug('success', '‚úÖ Firebase conectado correctamente');
                    try {
                        await window.database.ref('.info/connected').once('value');
                        this.logDebug('success', '‚úÖ Conexi√≥n Firebase activa');
                    } catch (error) {
                        this.logDebug('error', `‚ùå Error de conexi√≥n Firebase: ${error.message}`);
                    }
                } else {
                    this.logDebug('warning', '‚ö†Ô∏è Firebase no disponible, trabajando offline');
                }
                
                // 2. Verificar datos locales
                this.logDebug('info', 'üíæ Verificando datos locales...');
                const localUsers = localStorage.getItem('inventario_users');
                const localStores = localStorage.getItem('inventario_stores');
                const localAssignments = localStorage.getItem('inventario_assignments');
                
                if (localUsers) {
                    this.logDebug('success', `‚úÖ Usuarios locales: ${JSON.parse(localUsers).length}`);
                } else {
                    this.logDebug('warning', '‚ö†Ô∏è No hay usuarios locales');
                }
                
                if (localStores) {
                    this.logDebug('success', `‚úÖ Tiendas locales: ${JSON.parse(localStores).length}`);
                } else {
                    this.logDebug('warning', '‚ö†Ô∏è No hay tiendas locales');
                }
                
                if (localAssignments) {
                    this.logDebug('success', `‚úÖ Asignaciones locales: ${Object.keys(JSON.parse(localAssignments)).length}`);
                } else {
                    this.logDebug('warning', '‚ö†Ô∏è No hay asignaciones locales');
                }
                
                // 3. Verificar integridad de datos
                this.logDebug('info', 'üîí Verificando integridad de datos...');
                let issues = 0;
                
                // Verificar usuarios duplicados
                const usernames = this.users.map(u => u.username);
                const duplicateUsers = usernames.filter((name, index) => usernames.indexOf(name) !== index);
                if (duplicateUsers.length > 0) {
                    this.logDebug('error', `‚ùå Usuarios duplicados: ${duplicateUsers.join(', ')}`);
                    issues++;
                } else {
                    this.logDebug('success', '‚úÖ No hay usuarios duplicados');
                }
                
                // Verificar tiendas duplicadas
                const storeNames = this.stores.map(s => s.name);
                const duplicateStores = storeNames.filter((name, index) => storeNames.indexOf(name) !== index);
                if (duplicateStores.length > 0) {
                    this.logDebug('error', `‚ùå Tiendas duplicadas: ${duplicateStores.join(', ')}`);
                    issues++;
                } else {
                    this.logDebug('success', '‚úÖ No hay tiendas duplicadas');
                }
                
                // 4. Verificar asignaciones inv√°lidas
                this.logDebug('info', 'üë• Verificando asignaciones...');
                let invalidAssignments = 0;
                Object.entries(this.assignments).forEach(([userId, storeIds]) => {
                    const user = this.users.find(u => u.id === userId);
                    if (!user) {
                        this.logDebug('error', `‚ùå Asignaci√≥n a usuario inexistente: ${userId}`);
                        invalidAssignments++;
                        return;
                    }
                    
                    storeIds.forEach(storeId => {
                        const store = this.stores.find(s => s.id === storeId);
                        if (!store) {
                            this.logDebug('error', `‚ùå Asignaci√≥n a tienda inexistente: ${storeId}`);
                            invalidAssignments++;
                        }
                    });
                });
                
                if (invalidAssignments === 0) {
                    this.logDebug('success', '‚úÖ Todas las asignaciones son v√°lidas');
                }
                
                // 5. Resumen
                this.logDebug('info', '=' .repeat(50));
                if (issues === 0 && invalidAssignments === 0) {
                    this.logDebug('success', 'üéâ DIAGN√ìSTICO COMPLETADO SIN ERRORES');
                } else {
                    this.logDebug('warning', `‚ö†Ô∏è DIAGN√ìSTICO COMPLETADO CON ${issues + invalidAssignments} PROBLEMAS`);
                }
                
                this.updateDebugStats();
            }

            // Limpiar todos los datos
            async clearAllData() {
                if (!confirm('‚ö†Ô∏è ESTA ACCI√ìN ELIMINAR√Å TODOS LOS DATOS\n\n¬øEst√°s absolutamente seguro? Esta acci√≥n no se puede deshacer.')) {
                    return;
                }
                
                this.logDebug('warning', 'üóëÔ∏è ELIMINANDO TODOS LOS DATOS...');
                
                try {
                    // Limpiar localStorage
                    localStorage.removeItem('inventario_users');
                    localStorage.removeItem('inventario_stores');
                    localStorage.removeItem('inventario_assignments');
                    localStorage.removeItem('currentUser');
                    
                    // Limpiar Firebase
                    if (this.firebaseReady && window.database) {
                        await window.database.ref('users').remove();
                        await window.database.ref('stores').remove();
                        await window.database.ref('assignments').remove();
                        this.logDebug('success', '‚úÖ Datos eliminados de Firebase');
                    }
                    
                    // Resetear variables
                    this.users = [];
                    this.stores = [];
                    this.assignments = {};
                    
                    // Recrear admin por defecto
                    this.users = [{
                        id: 'admin_default',
                        name: 'Administrador',
                        username: 'admin',
                        password: 'admin123',
                        role: 'admin',
                        permissions: {
                            read: true,
                            write: true,
                            delete: true,
                            manage_users: true
                        },
                        createdAt: new Date().toISOString(),
                        lastLogin: new Date().toISOString()
                    }];
                    
                    // Recrear tiendas por defecto
                    this.stores = [
                        {
                            id: 'store_1',
                            name: 'La Estancia',
                            address: 'Avenia Caracas 70A - 89',
                            sector: 'Tienda sector Caracas',
                            phone: '',
                            products: 0,
                            units: 0,
                            needs: 0
                        },
                        {
                            id: 'store_2',
                            name: 'Animal World',
                            address: 'Calle 58 #127-88',
                            sector: 'Tienda del sector norte',
                            phone: '',
                            products: 0,
                            units: 0,
                            needs: 0
                        }
                    ];
                    
                    await this.saveUsers();
                    await this.saveStores();
                    await this.saveAssignments();
                    
                    this.renderCurrentTab();
                    this.updateStats();
                    
                    this.logDebug('success', '‚úÖ Sistema reseteado correctamente');
                    this.showNotification('Sistema reseteado correctamente');
                    
                } catch (error) {
                    this.logDebug('error', `‚ùå Error reseteando sistema: ${error.message}`);
                }
            }

            // Exportar datos
            exportData() {
                const exportData = {
                    version: '4.0',
                    timestamp: new Date().toISOString(),
                    data: {
                        users: this.users,
                        stores: this.stores,
                        assignments: this.assignments
                    }
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `inventario_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                this.logDebug('success', '‚úÖ Datos exportados correctamente');
                this.showNotification('Datos exportados correctamente');
            }

            // Importar datos
            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    try {
                        const text = await file.text();
                        const importData = JSON.parse(text);
                        
                        if (!importData.data) {
                            throw new Error('Formato de archivo inv√°lido');
                        }
                        
                        // Validar y cargar datos
                        if (importData.data.users && Array.isArray(importData.data.users)) {
                            this.users = importData.data.users;
                        }
                        
                        if (importData.data.stores && Array.isArray(importData.data.stores)) {
                            this.stores = importData.data.stores;
                        }
                        
                        if (importData.data.assignments && typeof importData.data.assignments === 'object') {
                            this.assignments = importData.data.assignments;
                        }
                        
                        await this.saveUsers();
                        await this.saveStores();
                        await this.saveAssignments();
                        
                        this.renderCurrentTab();
                        this.updateStats();
                        
                        this.logDebug('success', '‚úÖ Datos importados correctamente');
                        this.showNotification('Datos importados correctamente');
                        
                    } catch (error) {
                        this.logDebug('error', `‚ùå Error importando datos: ${error.message}`);
                        alert('Error importando datos: ' + error.message);
                    }
                };
                
                input.click();
            }

            // Actualizar estado del sistema
            updateSystemStatus() {
                const systemStatus = document.getElementById('systemStatus');
                if (!systemStatus) return;
                
                const status = [
                    { label: 'Firebase', value: this.firebaseReady ? 'Conectado' : 'Offline', color: this.firebaseReady ? 'text-green-600' : 'text-orange-600' },
                    { label: 'Usuarios', value: this.users.length, color: 'text-gray-700' },
                    { label: 'Tiendas', value: this.stores.length, color: 'text-gray-700' },
                    { label: 'Asignaciones', value: Object.keys(this.assignments).length, color: 'text-gray-700' },
                    { label: 'Navegador', value: navigator.userAgent.split(' ')[0], color: 'text-gray-700' },
                    { label: '√öltima actualizaci√≥n', value: new Date().toLocaleTimeString(), color: 'text-gray-700' }
                ];
                
                systemStatus.innerHTML = status.map(item => `
                    <div class="flex justify-between">
                        <span class="text-gray-600">${item.label}:</span>
                        <span class="${item.color} font-medium">${item.value}</span>
                    </div>
                `).join('');
            }

            // Actualizar estad√≠sticas de debug
            updateDebugStats() {
                const debugStats = document.getElementById('debugStats');
                if (!debugStats) return;
                
                const stats = [
                    { label: 'Uso localStorage', value: `${(JSON.stringify(localStorage).length / 1024).toFixed(2)} KB` },
                    { label: 'Logs de debug', value: this.debugLogs.length },
                    { label: 'Pesta√±a actual', value: this.currentTab },
                    { label: 'Modo edici√≥n', value: this.editingUser || this.editingStore ? 'Activo' : 'Inactivo' }
                ];
                
                debugStats.innerHTML = stats.map(item => `
                    <div class="flex justify-between">
                        <span class="text-gray-600">${item.label}:</span>
                        <span class="text-gray-800 font-medium">${item.value}</span>
                    </div>
                `).join('');
            }

            // Limpiar consola de debug
            clearDebugConsole() {
                this.debugLogs = [];
                const console = document.getElementById('debugConsole');
                if (console) {
                    console.innerHTML = '';
                }
            }

            // Agregar log a la consola de debug
            logDebug(type, message) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = { timestamp, type, message };
                this.debugLogs.push(logEntry);
                
                // Mantener solo los √∫ltimos 100 logs
                if (this.debugLogs.length > 100) {
                    this.debugLogs.shift();
                }
                
                // Tambi√©n mostrar en consola del navegador
                console.log(`[${timestamp}] ${message}`);
                
                // Actualizar consola visual si est√° abierta
                const console = document.getElementById('debugConsole');
                if (console) {
                    const logClass = `debug-${type}`;
                    const logHtml = `<div class="debug-line ${logClass}">[${timestamp}] ${message}</div>`;
                    console.innerHTML += logHtml;
                    console.scrollTop = console.scrollHeight;
                }
            }

            // Obtener etiqueta de permiso
            getPermissionLabel(permission) {
                const labels = {
                    read: 'Leer',
                    write: 'Escribir',
                    delete: 'Eliminar',
                    manage_users: 'Gestionar Usuarios'
                };
                return labels[permission] || permission;
            }

            // Mostrar notificaci√≥n
            showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                const notificationText = document.getElementById('notificationText');
                
                notificationText.textContent = message;
                notification.classList.remove('hidden');
                
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 3000);
            }
        }

        // Funci√≥n global para logout
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        // Inicializar el sistema
        const userManager = new UserManager();
    </script>
</body>
</html>