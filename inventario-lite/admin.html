<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Inventario Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .user-card {
            transition: all 0.3s ease;
        }
        
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .badge-role {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-admin {
            background: #ef4444;
            color: white;
        }
        
        .badge-employee {
            background: #3b82f6;
            color: white;
        }
        
        .permission-tag {
            display: inline-block;
            padding: 2px 8px;
            background: #f3f4f6;
            border-radius: 4px;
            font-size: 0.75rem;
            margin: 2px;
        }
        
        .btn-action {
            transition: all 0.2s ease;
        }
        
        .btn-action:hover {
            transform: scale(1.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto p-4">
        <!-- Header -->
        <header class="glass-effect rounded-2xl shadow-xl p-6 mb-6 fade-in">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-users-cog text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Panel de Administración</h1>
                        <p class="text-gray-600">Gestión de usuarios y permisos</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="window.location.href='index.html'" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                        <i class="fas fa-arrow-left mr-2"></i>Volver al Inventario
                    </button>
                    <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                        <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                    </button>
                </div>
            </div>
        </header>

        <!-- Estadísticas -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="glass-effect rounded-xl p-6 text-center fade-in">
                <div class="text-3xl font-bold text-purple-600" id="totalUsers">0</div>
                <div class="text-gray-600">Total Usuarios</div>
            </div>
            <div class="glass-effect rounded-xl p-6 text-center fade-in">
                <div class="text-3xl font-bold text-red-600" id="adminCount">0</div>
                <div class="text-gray-600">Administradores</div>
            </div>
            <div class="glass-effect rounded-xl p-6 text-center fade-in">
                <div class="text-3xl font-bold text-blue-600" id="employeeCount">0</div>
                <div class="text-gray-600">Empleados</div>
            </div>
        </div>

        <!-- Lista de Usuarios -->
        <div class="glass-effect rounded-2xl shadow-xl p-6 fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Usuarios Registrados</h2>
                <button onclick="openUserModal()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                    <i class="fas fa-user-plus mr-2"></i>Nuevo Usuario
                </button>
            </div>
            
            <div id="usersList" class="space-y-4">
                <!-- Usuarios se cargarán aquí -->
            </div>
            
            <div id="emptyState" class="text-center py-12 hidden">
                <i class="fas fa-users text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">No hay usuarios registrados</h3>
                <p class="text-gray-500">Crea el primer usuario para comenzar</p>
            </div>
        </div>
    </div>

    <!-- Modal de Usuario -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800" id="modalTitle">Nuevo Usuario</h2>
                <button onclick="closeUserModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="userForm" class="space-y-4">
                <input type="hidden" id="userId">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                        <input type="text" id="userName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Usuario *</label>
                        <input type="text" id="userUsername" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contraseña *</label>
                    <input type="password" id="userPassword" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1">Mínimo 6 caracteres</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Rol *</label>
                    <select id="userRole" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">Seleccionar rol</option>
                        <option value="admin">Administrador</option>
                        <option value="employee">Empleado</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Permisos</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="perm_read" checked class="mr-2 rounded text-purple-600">
                            <span>Leer inventario</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="perm_write" class="mr-2 rounded text-purple-600">
                            <span>Editar productos y stock</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="perm_delete" class="mr-2 rounded text-purple-600">
                            <span>Eliminar productos</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="perm_manage_users" class="mr-2 rounded text-purple-600">
                            <span>Gestionar usuarios</span>
                        </label>
                    </div>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                        <i class="fas fa-save mr-2"></i>Guardar Usuario
                    </button>
                    <button type="button" onclick="closeUserModal()" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notificación -->
    <div id="notification" class="fixed top-4 right-4 bg-white px-6 py-4 rounded-lg shadow-lg border-l-4 border-green-500 hidden z-50">
        <div class="flex items-center">
            <i class="fas fa-check-circle text-green-500 mr-3"></i>
            <span id="notificationText"></span>
        </div>
    </div>

    <script>
        // Sistema de Administración de Usuarios
        class UserAdmin {
            constructor() {
                this.users = [];
                this.editingUser = null;
                this.init();
            }

            init() {
                this.checkAdminAccess();
                this.loadUsers();
                this.setupEventListeners();
                this.renderUsers();
                this.updateStats();
            }

            checkAdminAccess() {
                const session = localStorage.getItem('inventario_session');
                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }
                
                const sessionData = JSON.parse(session);
                const expiresAt = new Date(sessionData.expiresAt);
                
                if (expiresAt <= new Date()) {
                    localStorage.removeItem('inventario_session');
                    window.location.href = 'login.html';
                    return;
                }
                
                // Verificar si es administrador
                if (!sessionData.user.permissions.includes('manage_users')) {
                    alert('No tienes permisos para acceder a esta página');
                    window.location.href = 'index.html';
                    return;
                }
            }

            loadUsers() {
                try {
                    const stored = localStorage.getItem('inventario_users');
                    if (stored) {
                        this.users = JSON.parse(stored);
                    }
                } catch (error) {
                    console.error('Error cargando usuarios:', error);
                }
            }

            saveUsers() {
                try {
                    localStorage.setItem('inventario_users', JSON.stringify(this.users));
                } catch (error) {
                    console.error('Error guardando usuarios:', error);
                }
            }

            setupEventListeners() {
                const form = document.getElementById('userForm');
                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.saveUser();
                    });
                }

                // Cambio de rol
                const roleSelect = document.getElementById('userRole');
                if (roleSelect) {
                    roleSelect.addEventListener('change', () => {
                        this.updatePermissionsByRole();
                    });
                }

                // Cerrar modal con ESC
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.closeUserModal();
                });
            }

            updatePermissionsByRole() {
                const role = document.getElementById('userRole').value;
                const isEditing = !!this.editingUser;
                
                if (role === 'admin') {
                    document.getElementById('perm_read').checked = true;
                    document.getElementById('perm_write').checked = true;
                    document.getElementById('perm_delete').checked = true;
                    document.getElementById('perm_manage_users').checked = true;
                } else if (role === 'employee') {
                    document.getElementById('perm_read').checked = true;
                    document.getElementById('perm_write').checked = true;
                    document.getElementById('perm_delete').checked = false;
                    document.getElementById('perm_manage_users').checked = false;
                }
                
                // Deshabilitar edición de permisos si no es admin
                const isAdmin = document.querySelector('.badge-admin') !== null;
                const permissionCheckboxes = document.querySelectorAll('[id^="perm_"]');
                permissionCheckboxes.forEach(checkbox => {
                    checkbox.disabled = role === 'admin' && !isEditing;
                });
            }

            saveUser() {
                const name = document.getElementById('userName').value.trim();
                const username = document.getElementById('userUsername').value.trim();
                const password = document.getElementById('userPassword').value;
                const role = document.getElementById('userRole').value;
                
                const permissions = [];
                if (document.getElementById('perm_read').checked) permissions.push('read');
                if (document.getElementById('perm_write').checked) permissions.push('write');
                if (document.getElementById('perm_delete').checked) permissions.push('delete');
                if (document.getElementById('perm_manage_users').checked) permissions.push('manage_users');

                if (!name || !username || !password || !role) {
                    this.showNotification('Por favor completa todos los campos obligatorios', 'error');
                    return;
                }

                if (password.length < 6) {
                    this.showNotification('La contraseña debe tener al menos 6 caracteres', 'error');
                    return;
                }

                // Verificar si el username ya existe
                const existingUser = this.users.find(u => u.username === username && u.id !== this.editingUser?.id);
                if (existingUser) {
                    this.showNotification('El nombre de usuario ya existe', 'error');
                    return;
                }

                if (this.editingUser) {
                    const index = this.users.findIndex(u => u.id === this.editingUser.id);
                    if (index !== -1) {
                        this.users[index] = {
                            ...this.users[index],
                            name,
                            username,
                            password,
                            role,
                            permissions,
                            updatedAt: new Date().toISOString()
                        };
                    }
                } else {
                    const newUser = {
                        id: Date.now(),
                        name,
                        username,
                        password,
                        role,
                        permissions,
                        createdAt: new Date().toISOString()
                    };
                    this.users.push(newUser);
                }

                this.saveUsers();
                this.renderUsers();
                this.updateStats();
                this.closeUserModal();
                this.showNotification(this.editingUser ? 'Usuario actualizado' : 'Usuario creado', 'success');
            }

            deleteUser(id) {
                const user = this.users.find(u => u.id === id);
                if (!user) return;

                // No permitir eliminar al último administrador
                if (user.role === 'admin') {
                    const adminCount = this.users.filter(u => u.role === 'admin').length;
                    if (adminCount <= 1) {
                        this.showNotification('No puedes eliminar al último administrador', 'error');
                        return;
                    }
                }

                if (confirm(`¿Estás seguro de que quieres eliminar al usuario "${user.name}"?`)) {
                    this.users = this.users.filter(u => u.id !== id);
                    this.saveUsers();
                    this.renderUsers();
                    this.updateStats();
                    this.showNotification('Usuario eliminado', 'success');
                }
            }

            editUser(id) {
                const user = this.users.find(u => u.id === id);
                if (!user) return;

                this.editingUser = user;
                document.getElementById('modalTitle').textContent = 'Editar Usuario';
                document.getElementById('userId').value = user.id;
                document.getElementById('userName').value = user.name;
                document.getElementById('userUsername').value = user.username;
                document.getElementById('userPassword').value = user.password;
                document.getElementById('userRole').value = user.role;
                
                // Establecer permisos
                document.getElementById('perm_read').checked = user.permissions.includes('read');
                document.getElementById('perm_write').checked = user.permissions.includes('write');
                document.getElementById('perm_delete').checked = user.permissions.includes('delete');
                document.getElementById('perm_manage_users').checked = user.permissions.includes('manage_users');
                
                this.updatePermissionsByRole();
                this.openUserModal();
            }

            renderUsers() {
                const container = document.getElementById('usersList');
                const emptyState = document.getElementById('emptyState');
                
                if (!container) return;

                if (this.users.length === 0) {
                    container.innerHTML = '';
                    if (emptyState) emptyState.classList.remove('hidden');
                    return;
                }

                if (emptyState) emptyState.classList.add('hidden');
                
                container.innerHTML = this.users.map(user => `
                    <div class="user-card bg-white rounded-xl p-6 shadow-md">
                        <div class="flex justify-between items-start flex-wrap gap-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                                        <span class="text-white font-bold text-lg">${user.name.charAt(0).toUpperCase()}</span>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-lg text-gray-800">${this.escapeHtml(user.name)}</h3>
                                        <p class="text-gray-600">@${this.escapeHtml(user.username)}</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="badge-role ${user.role === 'admin' ? 'badge-admin' : 'badge-employee'}">
                                        ${user.role === 'admin' ? 'Administrador' : 'Empleado'}
                                    </span>
                                </div>
                                
                                <div class="flex flex-wrap gap-1">
                                    ${user.permissions.map(perm => {
                                        const permNames = {
                                            'read': 'Leer',
                                            'write': 'Escribir',
                                            'delete': 'Eliminar',
                                            'manage_users': 'Gestionar Usuarios'
                                        };
                                        return `<span class="permission-tag">${permNames[perm] || perm}</span>`;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <div class="flex gap-2">
                                <button onclick="userAdmin.editUser(${user.id})" class="btn-action p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="userAdmin.deleteUser(${user.id})" class="btn-action p-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            updateStats() {
                const totalUsers = this.users.length;
                const adminCount = this.users.filter(u => u.role === 'admin').length;
                const employeeCount = this.users.filter(u => u.role === 'employee').length;

                document.getElementById('totalUsers').textContent = totalUsers;
                document.getElementById('adminCount').textContent = adminCount;
                document.getElementById('employeeCount').textContent = employeeCount;
            }

            openUserModal() {
                document.getElementById('userModal').style.display = 'block';
                document.body.style.overflow = 'hidden';
            }

            closeUserModal() {
                document.getElementById('userModal').style.display = 'none';
                document.body.style.overflow = 'auto';
                this.resetForm();
            }

            resetForm() {
                const form = document.getElementById('userForm');
                if (form) form.reset();
                
                document.getElementById('userId').value = '';
                document.getElementById('modalTitle').textContent = 'Nuevo Usuario';
                this.editingUser = null;
                
                // Resetear permisos
                document.getElementById('perm_read').checked = true;
                document.getElementById('perm_write').checked = false;
                document.getElementById('perm_delete').checked = false;
                document.getElementById('perm_manage_users').checked = false;
            }

            showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                const notificationText = document.getElementById('notificationText');
                
                if (!notification || !notificationText) return;
                
                notificationText.textContent = message;
                notification.className = `fixed top-4 right-4 bg-white px-6 py-4 rounded-lg shadow-lg border-l-4 z-50`;
                
                if (type === 'error') {
                    notification.classList.add('border-red-500');
                    notification.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
                            <span>${message}</span>
                        </div>
                    `;
                } else {
                    notification.classList.add('border-green-500');
                    notification.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-3"></i>
                            <span>${message}</span>
                        </div>
                    `;
                }
                
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Funciones globales
        function openUserModal() {
            userAdmin.openUserModal();
        }

        function closeUserModal() {
            userAdmin.closeUserModal();
        }

        function logout() {
            if (confirm('¿Está seguro de que desea cerrar sesión?')) {
                localStorage.removeItem('inventario_session');
                window.location.href = 'login.html';
            }
        }

        // Inicializar
        let userAdmin;
        document.addEventListener('DOMContentLoaded', () => {
            userAdmin = new UserAdmin();
        });
    </script>
</body>
</html>