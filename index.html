<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .store-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .store-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .store-card.selected {
            border-color: #7c3aed;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .btn {
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .nav-btn {
            transition: all 0.2s ease;
        }
        
        .nav-btn:hover {
            transform: translateY(-1px);
        }
        
        .nav-btn:active {
            transform: translateY(0);
        }
    </style>
</head>
<body class="gradient-bg">
    <!-- Header Principal -->
    <header class="glass-effect rounded-2xl shadow-xl p-6 mb-6 fade-in">
        <div class="flex justify-between items-center flex-wrap gap-4">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center">
                    <i class="fas fa-store text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Sistema de Inventario</h1>
                    <p class="text-gray-600">Gestión MultiTienda</p>
                </div>
            </div>
            
            <!-- Navegación Principal -->
            <nav class="flex items-center gap-3">
                <div class="text-right mr-4">
                    <div class="text-sm font-medium text-gray-800" id="currentUser">Cargando...</div>
                    <div class="text-xs text-gray-600" id="userRole">Cargando...</div>
                </div>
                
                <div class="flex gap-2">
                    <!-- Botones de navegación -->
                    <button onclick="showStoreSelection()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 nav-btn">
                        <i class="fas fa-store mr-2"></i>Tiendas
                    </button>
                    
                    <button onclick="goToAdmin()" id="adminBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 nav-btn hidden">
                        <i class="fas fa-users-cog mr-2"></i>Admin
                    </button>
                    
                    <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 nav-btn">
                        <i class="fas fa-sign-out-alt mr-2"></i>Salir
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Contenedor Principal -->
    <div class="container mx-auto p-4">
        <!-- Selección de Tiendas -->
        <div id="storeSelectionView" class="glass-effect rounded-2xl shadow-xl p-6 fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-store mr-2 text-purple-600"></i>Mis Tiendas
                </h2>
                <button onclick="refreshStores()" class="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 btn text-sm">
                    <i class="fas fa-sync-alt mr-1"></i>Actualizar
                </button>
            </div>
            
            <div id="storesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Las tiendas se cargarán aquí -->
            </div>
            
            <div id="noStoresMessage" class="text-center py-8 hidden">
                <i class="fas fa-store-slash text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">No tienes tiendas asignadas</h3>
                <p class="text-gray-500">Contacta al administrador para que te asigne tiendas</p>
            </div>
        </div>

        <!-- Vista de Inventario -->
        <div id="inventoryView" class="hidden">
            <!-- Info de Tienda Seleccionada -->
            <div class="glass-effect rounded-2xl shadow-xl p-6 mb-6 fade-in">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-store mr-2 text-purple-600"></i>
                            <span id="selectedStoreName">Tienda</span>
                        </h2>
                        <p class="text-gray-600" id="selectedStoreAddress">Dirección</p>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold text-purple-600" id="storeProducts">0</div>
                            <div class="text-sm text-gray-600">Productos</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-blue-600" id="storeUnits">0</div>
                            <div class="text-sm text-gray-600">Unidades</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-orange-600" id="storeLowStock">0</div>
                            <div class="text-sm text-gray-600">Stock Bajo</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controles -->
            <div class="glass-effect rounded-2xl shadow-xl p-6 mb-6 fade-in">
                <div class="flex flex-wrap gap-4 justify-between items-center">
                    <div class="flex flex-wrap gap-3">
                        <button onclick="openProductModal()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 btn">
                            <i class="fas fa-plus mr-2"></i>Nuevo Producto
                        </button>
                        <button onclick="openImportModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 btn">
                            <i class="fas fa-file-import mr-2"></i>Importar
                        </button>
                        <button onclick="exportData()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 btn">
                            <i class="fas fa-download mr-2"></i>Exportar
                        </button>
                        <button onclick="generateExcelReport()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 btn">
                            <i class="fas fa-file-excel mr-2"></i>Generar reporte en Excel
                        </button>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="text" 
                               id="searchInput" 
                               placeholder="Buscar..." 
                               onkeyup="filterProducts()"
                               class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
            </div>

            <!-- Tabla de Productos -->
            <div class="glass-effect rounded-2xl shadow-xl p-6 fade-in">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Inventario de Productos</h3>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Código</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Producto</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Categoría</th>
                                <th class="text-center py-3 px-4 font-semibold text-gray-700">Stock</th>
                                <th class="text-center py-3 px-4 font-semibold text-gray-700">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <!-- Los productos se cargarán aquí -->
                        </tbody>
                    </table>
                </div>
                
                <div id="noProductsMessage" class="text-center py-12 hidden">
                    <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">No hay productos</h3>
                    <p class="text-gray-500">Agrega tu primer producto para comenzar</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Producto -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800" id="modalTitle">Nuevo Producto</h2>
                <button onclick="closeProductModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="productForm" onsubmit="saveProduct(event)" class="space-y-4">
                <input type="hidden" id="productId">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Código *</label>
                        <input type="text" id="productCode" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre *</label>
                        <input type="text" id="productName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Categoría</label>
                        <select id="productCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="">Seleccionar categoría</option>
                            <option value="Alimentos">Alimentos</option>
                            <option value="Accesorios">Accesorios</option>
                            <option value="Juguetes">Juguetes</option>
                            <option value="Salud">Salud</option>
                            <option value="Higiene">Higiene</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Stock Inicial *</label>
                        <input type="number" id="productStock" required min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descripción</label>
                    <textarea id="productDescription" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 btn">
                        <i class="fas fa-save mr-2"></i>Guardar
                    </button>
                    <button type="button" onclick="closeProductModal()" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 btn">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Importación -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Importar Productos</h2>
                <button onclick="closeImportModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Archivo CSV</label>
                    <input type="file" id="importFile" accept=".csv" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    <p class="text-xs text-gray-500 mt-1">El archivo debe tener las columnas: código, nombre, categoría, stock</p>
                </div>
                
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2">Formato del archivo:</h4>
                    <div class="text-sm text-blue-700 font-mono">
                        código,nombre,categoría,stock<br>
                        PROD001,Producto A,Alimentos,10<br>
                        PROD002,Producto B,Accesorios,5
                    </div>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button onclick="importProducts()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 btn">
                        <i class="fas fa-file-import mr-2"></i>Importar
                    </button>
                    <button onclick="closeImportModal()" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 btn">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notificación -->
    <div id="notification" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-4 flex items-center gap-3 min-w-[300px]">
            <div id="notificationIcon"></div>
            <div>
                <div id="notificationTitle" class="font-semibold text-gray-800"></div>
                <div id="notificationMessage" class="text-sm text-gray-600"></div>
            </div>
        </div>
    </div>

    <script>
        // Estado Global
        let currentUser = null;
        let selectedStore = null;
        let stores = [];
        let products = [];
        let userAssignments = [];

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadUserData();
            loadUserAssignments();
            loadStores();
        });

        // Autenticación
        function checkAuth() {
            const user = localStorage.getItem('currentUser');
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = JSON.parse(user);
        }

        function loadUserData() {
            if (currentUser) {
                document.getElementById('currentUser').textContent = currentUser.name || currentUser.username;
                document.getElementById('userRole').textContent = currentUser.role === 'admin' ? 'Administrador' : 'Empleado';
                
                // Mostrar botón de admin solo si es administrador
                const adminBtn = document.getElementById('adminBtn');
                if (currentUser.role === 'admin') {
                    adminBtn.classList.remove('hidden');
                }
            }
        }

        function logout() {
            if (confirm('¿Estás seguro de que deseas salir?')) {
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            }
        }

        // Navegación
        function goToAdmin() {
            if (currentUser.role === 'admin') {
                window.location.href = 'admin.html';
            }
        }

        // Cargar asignaciones del usuario
        function loadUserAssignments() {
            if (currentUser.role === 'admin') {
                // Los administradores ven todas las tiendas
                userAssignments = ['la_estancia', 'animal_world'];
            } else {
                // Los empleados solo ven sus tiendas asignadas
                const assignments = localStorage.getItem('userAssignments');
                if (assignments) {
                    const allAssignments = JSON.parse(assignments);
                    userAssignments = allAssignments[currentUser.id] || [];
                } else {
                    userAssignments = [];
                }
            }
        }

        // Gestión de Tiendas
        function loadStores() {
            // Cargar todas las tiendas base
            const allStores = [
                {
                    id: 'la_estancia',
                    name: 'La Estancia',
                    address: 'Avenia Caracas 70A - 89',
                    sector: 'Caracas'
                },
                {
                    id: 'animal_world',
                    name: 'Animal World',
                    address: 'Calle 58 #127-88',
                    sector: 'Norte'
                }
            ];

            // Filtrar tiendas según las asignaciones del usuario
            stores = allStores.filter(store => userAssignments.includes(store.id));

            renderStores();
        }

        function renderStores() {
            const storesList = document.getElementById('storesList');
            const noStoresMessage = document.getElementById('noStoresMessage');

            if (stores.length === 0) {
                storesList.innerHTML = '';
                noStoresMessage.classList.remove('hidden');
                return;
            }

            noStoresMessage.classList.add('hidden');
            storesList.innerHTML = stores.map(store => {
                const storeProducts = getStoreProducts(store.id);
                const totalUnits = storeProducts.reduce((sum, p) => sum + parseInt(p.stock || 0), 0);
                const lowStock = storeProducts.filter(p => parseInt(p.stock || 0) < 5).length;

                return `
                    <div class="store-card bg-white rounded-xl p-6 shadow-lg ${selectedStore?.id === store.id ? 'selected' : ''}" 
                         onclick="selectStore('${store.id}')">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-store text-purple-600 text-xl"></i>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500">${store.sector}</div>
                            </div>
                        </div>
                        
                        <h3 class="text-lg font-bold text-gray-800 mb-2">${store.name}</h3>
                        <p class="text-sm text-gray-600 mb-4">${store.address}</p>
                        
                        <div class="grid grid-cols-3 gap-2 text-center mb-4">
                            <div>
                                <div class="text-lg font-bold text-purple-600">${storeProducts.length}</div>
                                <div class="text-xs text-gray-500">Productos</div>
                            </div>
                            <div>
                                <div class="text-lg font-bold text-blue-600">${totalUnits}</div>
                                <div class="text-xs text-gray-500">Unidades</div>
                            </div>
                            <div>
                                <div class="text-lg font-bold text-orange-600">${lowStock}</div>
                                <div class="text-xs text-gray-500">Stock Bajo</div>
                            </div>
                        </div>
                        
                        <button class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 btn">
                            <i class="fas fa-box mr-2"></i>Gestionar Inventario
                        </button>
                    </div>
                `;
            }).join('');
        }

        function refreshStores() {
            showNotification('info', 'Actualizando', 'Recargando lista de tiendas...');
            loadUserAssignments();
            loadStores();
        }

        function selectStore(storeId) {
            selectedStore = stores.find(s => s.id === storeId);
            if (!selectedStore) return;

            showInventoryView();
            loadProducts();
        }

        function showStoreSelection() {
            document.getElementById('storeSelectionView').classList.remove('hidden');
            document.getElementById('inventoryView').classList.add('hidden');
            selectedStore = null;
            renderStores();
        }

        function showInventoryView() {
            document.getElementById('storeSelectionView').classList.add('hidden');
            document.getElementById('inventoryView').classList.remove('hidden');
            
            document.getElementById('selectedStoreName').textContent = selectedStore.name;
            document.getElementById('selectedStoreAddress').textContent = selectedStore.address;
        }

        // Gestión de Productos
        function getStoreProducts(storeId) {
            const storeProducts = JSON.parse(localStorage.getItem('products_' + storeId) || '[]');
            return storeProducts;
        }

        function loadProducts() {
            if (!selectedStore) return;
            
            products = getStoreProducts(selectedStore.id);
            renderProducts();
            updateStoreStats();
        }

        function renderProducts() {
            const tbody = document.getElementById('productsTableBody');
            const noProductsMessage = document.getElementById('noProductsMessage');

            if (products.length === 0) {
                tbody.innerHTML = '';
                noProductsMessage.classList.remove('hidden');
                return;
            }

            noProductsMessage.classList.add('hidden');
            tbody.innerHTML = products.map(product => {
                const stockClass = parseInt(product.stock || 0) < 5 ? 'text-red-600' : 'text-green-600';
                const stockIcon = parseInt(product.stock || 0) < 5 ? 'fa-exclamation-triangle' : 'fa-check-circle';

                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-4">
                            <span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">${product.code}</span>
                        </td>
                        <td class="py-3 px-4">
                            <div class="font-medium text-gray-800">${product.name}</div>
                            ${product.description ? `<div class="text-sm text-gray-500">${product.description}</div>` : ''}
                        </td>
                        <td class="py-3 px-4">
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">
                                ${product.category || 'Sin categoría'}
                            </span>
                        </td>
                        <td class="py-3 px-4 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="adjustStock('${product.code}', -1)" class="w-6 h-6 bg-red-500 text-white rounded hover:bg-red-600 btn">
                                    <i class="fas fa-minus text-xs"></i>
                                </button>
                                <span class="${stockClass} font-bold">
                                    <i class="fas ${stockIcon} mr-1"></i>${product.stock}
                                </span>
                                <button onclick="adjustStock('${product.code}', 1)" class="w-6 h-6 bg-green-500 text-white rounded hover:bg-green-600 btn">
                                    <i class="fas fa-plus text-xs"></i>
                                </button>
                            </div>
                        </td>
                        <td class="py-3 px-4 text-center">
                            <div class="flex justify-center gap-2">
                                <button onclick="editProduct('${product.code}')" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 btn text-sm">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteProduct('${product.code}')" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 btn text-sm">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateStoreStats() {
            const totalProducts = products.length;
            const totalUnits = products.reduce((sum, p) => sum + parseInt(p.stock || 0), 0);
            const lowStock = products.filter(p => parseInt(p.stock || 0) < 5).length;

            document.getElementById('storeProducts').textContent = totalProducts;
            document.getElementById('storeUnits').textContent = totalUnits;
            document.getElementById('storeLowStock').textContent = lowStock;
        }

        function filterProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#productsTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Modal de Producto
        function openProductModal() {
            document.getElementById('modalTitle').textContent = 'Nuevo Producto';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('productModal').style.display = 'block';
        }

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        function saveProduct(event) {
            event.preventDefault();
            
            const code = document.getElementById('productCode').value.trim();
            const name = document.getElementById('productName').value.trim();
            const category = document.getElementById('productCategory').value;
            const stock = parseInt(document.getElementById('productStock').value) || 0;
            const description = document.getElementById('productDescription').value.trim();
            const productId = document.getElementById('productId').value;
            
            // Valores por defecto para precio y estado
            const price = 0;
            const status = 'activo';

            // Validar que no exista un producto con el mismo código (excepto si es edición)
            const existingProduct = products.find(p => p.code === code && p.id !== productId);
            if (existingProduct) {
                showNotification('error', 'Error', 'Ya existe un producto con este código');
                return;
            }

            if (productId) {
                // Editar producto existente
                const index = products.findIndex(p => p.id === productId);
                if (index !== -1) {
                    products[index] = {
                        ...products[index],
                        code,
                        name,
                        category,
                        stock,
                        price,
                        description,
                        status,
                        lastUpdated: new Date().toISOString().split('T')[0]
                    };
                }
                showNotification('success', 'Producto Actualizado', 'El producto ha sido actualizado correctamente');
            } else {
                // Crear nuevo producto
                const newProduct = {
                    id: Date.now().toString(),
                    code,
                    name,
                    category,
                    stock,
                    price,
                    description,
                    status,
                    lastUpdated: new Date().toISOString().split('T')[0],
                    createdAt: new Date().toISOString(),
                    storeId: selectedStore.id
                };
                products.push(newProduct);
                showNotification('success', 'Producto Creado', 'El producto ha sido agregado correctamente');
            }

            saveProducts();
            renderProducts();
            updateStoreStats();
            closeProductModal();
        }

        function editProduct(code) {
            const product = products.find(p => p.code === code);
            if (!product) return;

            document.getElementById('modalTitle').textContent = 'Editar Producto';
            document.getElementById('productId').value = product.id;
            document.getElementById('productCode').value = product.code;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category || '';
            document.getElementById('productStock').value = product.stock;
            document.getElementById('productDescription').value = product.description || '';
            
            document.getElementById('productModal').style.display = 'block';
        }

        function deleteProduct(code) {
            if (!confirm('¿Estás seguro de que deseas eliminar este producto?')) return;
            
            const index = products.findIndex(p => p.code === code);
            if (index !== -1) {
                products.splice(index, 1);
                saveProducts();
                renderProducts();
                updateStoreStats();
                showNotification('success', 'Producto Eliminado', 'El producto ha sido eliminado correctamente');
            }
        }

        function adjustStock(code, change) {
            const product = products.find(p => p.code === code);
            if (!product) return;

            const newStock = parseInt(product.stock || 0) + change;
            if (newStock < 0) return;

            product.stock = newStock;
            saveProducts();
            renderProducts();
            updateStoreStats();
        }

        function saveProducts() {
            if (!selectedStore) return;
            localStorage.setItem('products_' + selectedStore.id, JSON.stringify(products));
        }

        // Importación y Exportación
        function openImportModal() {
            document.getElementById('importModal').style.display = 'block';
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
            document.getElementById('importFile').value = '';
        }

        function importProducts() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('error', 'Error', 'Por favor selecciona un archivo');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());
                    
                    // Saltar la primera línea si es encabezado
                    const startIndex = lines[0].toLowerCase().includes('código') ? 1 : 0;
                    
                    let importedCount = 0;
                    let errorCount = 0;
                    
                    for (let i = startIndex; i < lines.length; i++) {
                        const parts = lines[i].split(',').map(p => p.trim());
                        
                        if (parts.length >= 4) {
                            const code = parts[0];
                            const name = parts[1];
                            const category = parts[2];
                            const stock = parseInt(parts[3]) || 0;
                            
                            // Validar que no exista el código
                            const existingProduct = products.find(p => p.code === code);
                            if (!existingProduct && code && name) {
                                const newProduct = {
                                    id: Date.now().toString() + '_' + i,
                                    code,
                                    name,
                                    category,
                                    stock,
                                    createdAt: new Date().toISOString()
                                };
                                products.push(newProduct);
                                importedCount++;
                            } else {
                                errorCount++;
                            }
                        }
                    }
                    
                    saveProducts();
                    renderProducts();
                    updateStoreStats();
                    closeImportModal();
                    
                    if (importedCount > 0) {
                        showNotification('success', 'Importación Completa', `Se importaron ${importedCount} productos correctamente${errorCount > 0 ? ` (${errorCount} con errores)` : ''}`);
                    } else {
                        showNotification('error', 'Error', 'No se pudieron importar productos. Verifica el formato del archivo.');
                    }
                    
                } catch (error) {
                    showNotification('error', 'Error', 'Ocurrió un error al procesar el archivo');
                }
            };
            
            reader.readAsText(file);
        }

        function exportData() {
            if (!selectedStore || products.length === 0) {
                showNotification('error', 'Error', 'No hay datos para exportar');
                return;
            }

            const csvContent = [
                ['código', 'nombre', 'categoría', 'stock'],
                ...products.map(p => [p.code, p.name, p.category || '', p.stock])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventario_${selectedStore.name}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification('success', 'Exportación Completa', 'Los datos han sido exportados correctamente');
        }

        // Función para generar reporte en Excel
        function generateExcelReport() {
            if (!selectedStore) {
                showNotification('error', 'Error', 'Por favor seleccione una tienda primero');
                return;
            }

            // Obtener productos de la tienda seleccionada
            const storeProducts = products.filter(product => product.storeId === selectedStore.id);
            
            if (storeProducts.length === 0) {
                showNotification('error', 'Error', 'No hay productos en la tienda seleccionada');
                return;
            }

            try {
                // Crear libro de Excel
                const wb = XLSX.utils.book_new();
                
                // Preparar datos para el Excel
                const excelData = storeProducts.map((product, index) => ({
                    'ID del producto': product.id || index + 1,
                    'Nombre': product.name || '',
                    'Descripción': product.description || '',
                    'Cantidad disponible': product.stock || 0,
                    'Precio': product.price || 0,
                    'Categoría': product.category || '',
                    'Fecha de última actualización': product.lastUpdated || new Date().toISOString().split('T')[0],
                    'Estado': product.status || 'activo'
                }));

                // Crear worksheet
                const ws = XLSX.utils.json_to_sheet(excelData);

                // Aplicar estilos a los encabezados
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                    if (!ws[cellAddress]) continue;
                    
                    ws[cellAddress].s = {
                        font: { bold: true },
                        fill: { fgColor: { rgb: "E0E0E0" } },
                        alignment: { horizontal: "center" }
                    };
                }

                // Ajustar ancho de columnas
                const colWidths = [
                    { wch: 15 }, // ID del producto
                    { wch: 25 }, // Nombre
                    { wch: 40 }, // Descripción
                    { wch: 18 }, // Cantidad disponible
                    { wch: 12 }, // Precio
                    { wch: 20 }, // Categoría
                    { wch: 20 }, // Fecha de última actualización
                    { wch: 12 }  // Estado
                ];
                ws['!cols'] = colWidths;

                // Agregar worksheet al libro
                XLSX.utils.book_append_sheet(wb, ws, "Inventario");

                // Generar nombre del archivo
                const storeName = selectedStore.name.replace(/[^a-zA-Z0-9]/g, '_');
                const currentDate = new Date().toISOString().split('T')[0];
                const fileName = `Reporte_${storeName}_${currentDate}.xlsx`;

                // Descargar archivo
                XLSX.writeFile(wb, fileName);

                showNotification('success', 'Reporte Generado', `El reporte "${fileName}" ha sido descargado correctamente`);

            } catch (error) {
                console.error('Error al generar reporte Excel:', error);
                showNotification('error', 'Error', 'No se pudo generar el reporte Excel. Por favor intente nuevamente.');
            }
        }

        // Notificaciones
        function showNotification(type, title, message) {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');

            const icons = {
                success: '<i class="fas fa-check-circle text-green-500 text-xl"></i>',
                error: '<i class="fas fa-exclamation-circle text-red-500 text-xl"></i>',
                info: '<i class="fas fa-info-circle text-blue-500 text-xl"></i>'
            };

            icon.innerHTML = icons[type] || icons.info;
            titleEl.textContent = title;
            messageEl.textContent = message;

            notification.classList.remove('hidden');
            notification.classList.add('fade-in');

            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        // Cerrar modales con ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeProductModal();
                closeImportModal();
            }
        });

        // Cerrar modales haciendo clic fuera
        window.onclick = function(event) {
            const productModal = document.getElementById('productModal');
            const importModal = document.getElementById('importModal');
            
            if (event.target === productModal) {
                closeProductModal();
            } else if (event.target === importModal) {
                closeImportModal();
            }
        }
    </script>
</body>
</html>